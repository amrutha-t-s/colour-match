<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ColorMatch Boutique - AI Skin Tone Detection</title>
    <meta
      name="description"
      content="AI-powered color matching by skin tone with camera detection"
    />
    <link rel="stylesheet" href="styles.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <header>
      <h1>üõçÔ∏è ColorMatch Boutique</h1>
      <p>AI Skin Tone Detection + Perfect Color Matches</p>
    </header>

    <main class="home-grid">
      <!-- CAMERA SKIN DETECTION -->
      <div class="camera-section">
        <h2>üì∏ Instant Skin Detection</h2>
        <p style="color: #666; margin-bottom: 1rem">
          Hold phone 30cm from face ‚Üí Click Analyze
        </p>
        <video
          id="video"
          autoplay
          playsinline
          muted
          width="320"
          height="240"
        ></video>
        <canvas id="canvas" style="display: none"></canvas>
        <button id="detect-skin" class="detect-btn">üîç Analyze My Skin</button>
        <div id="skin-result" class="result"></div>
      </div>

      <!-- INTERACTIVE COLOR WHEEL -->
      <div class="color-wheel-section">
        <h2>üé® Explore All Colors</h2>
        <canvas id="colorWheel" width="350" height="350"></canvas>
        <div id="wheelMatches" class="wheel-matches"></div>
        <button id="saveWheelColor" class="detect-btn" style="display: none">
          üíæ Save Best Match
        </button>
      </div>

      <!-- SKIN TYPE CARDS -->
      <a href="dusky.html" class="skin-card dusky-card">
        <h2>üåü Dusky Skin</h2>
        <p>Jewel tones & deep shades</p>
      </a>
      <a href="warm.html" class="skin-card warm-card">
        <h2>üåû Warm Skin</h2>
        <p>Peach, coral & golds</p>
      </a>
      <a href="cool.html" class="skin-card cool-card">
        <h2>‚ùÑÔ∏è Cool Skin</h2>
        <p>Blues, silvers & purples</p>
      </a>
      <a href="light.html" class="skin-card light-card">
        <h2>‚ú® Light Skin</h2>
        <p>Pastels & soft nudes</p>
      </a>
    </main>

    <div style="text-align: center">
      <a href="saved.html" class="view-saved-btn" id="saved-count-btn">
        üíé View Saved Colors <span id="saved-count">(0)</span>
      </a>
    </div>

    <footer>
      <p>¬© 2026 ColorMatch Boutique | AI-Powered by Camera Detection</p>
    </footer>

    <script>
      // üî• SKIN TONE DETECTOR (COMPLETE)
      class SkinToneDetector {
        constructor() {
          this.video = document.getElementById("video");
          this.canvas = document.getElementById("canvas");
          this.ctx = this.canvas.getContext("2d");
          this.detectBtn = document.getElementById("detect-skin");
          this.result = document.getElementById("skin-result");
          this.initCamera();
          this.detectBtn.addEventListener("click", () => this.detect());
        }

        async initCamera() {
          try {
            const stream = await navigator.mediaDevices.getUserMedia({
              video: { width: 320, height: 240, facingMode: "user" },
            });
            this.video.srcObject = stream;
          } catch (err) {
            this.result.innerHTML = "üì± Enable camera for AI magic ‚ú®";
          }
        }

        detect() {
          this.canvas.width = this.video.videoWidth;
          this.canvas.height = this.video.videoHeight;
          this.ctx.drawImage(this.video, 0, 0);

          const imageData = this.ctx.getImageData(
            0,
            0,
            this.canvas.width,
            this.canvas.height,
          );
          const skinTone = this.analyzeSkin(imageData.data);
          this.showResult(skinTone);
        }

        analyzeSkin(data) {
          let r = 0,
            g = 0,
            b = 0,
            skinPixels = 0;
          const step = 4;
          const totalPixels = (this.canvas.width * this.canvas.height) / step;

          for (
            let i = totalPixels * 0.25 * step;
            i < totalPixels * 0.75 * step;
            i += step
          ) {
            r = data[i];
            g = data[i + 1];
            b = data[i + 2];
            if (this.isSkinColor(r, g, b)) {
              r += 20;
              g += 10;
              b -= 10;
              skinPixels++;
            }
          }

          const avgR = r / Math.max(skinPixels, 1);
          const avgG = g / Math.max(skinPixels, 1);
          const avgB = b / Math.max(skinPixels, 1);

          return this.classifySkinTone(avgR, avgG, avgB);
        }

        isSkinColor(r, g, b) {
          r /= 255;
          g /= 255;
          b /= 255;
          return r > 0.2 && g > 0.1 && b < 0.7 && r > g * 1.2 && r < b * 1.5;
        }

        classifySkinTone(r, g, b) {
          const brightness = (r + g + b) / 3;
          const warmth = (r - b) / (r + b + 0.1);

          if (brightness > 0.65) return "light";
          if (warmth > 0.15) return "warm";
          if (brightness < 0.35) return "dusky";
          return "cool";
        }

        showResult(skinTone) {
          const pages = {
            dusky: "dusky.html",
            warm: "warm.html",
            cool: "cool.html",
            light: "light.html",
          };

          this.result.className = `result ${skinTone}`;
          this.result.innerHTML = `
            üéâ Detected: <strong>${skinTone.charAt(0).toUpperCase() + skinTone.slice(1)} Skin</strong><br>
            <a href="${pages[skinTone]}" class="detect-btn" style="margin-top: 1rem; display: inline-block;">‚ú® View My Colors</a>
          `;
        }
      }

      // üî• FIXED COLOR WHEEL (COMPLETE)
      class ColorWheel {
        constructor() {
          this.canvas = document.getElementById("colorWheel");
          this.ctx = this.canvas.getContext("2d");
          this.matchesDiv = document.getElementById("wheelMatches");
          this.saveBtn = document.getElementById("saveWheelColor");
          this.isDragging = false;
          this.centerX = 175;
          this.centerY = 175;
          this.radius = 160;

          this.allColors = [
            { name: "Deep Red", hex: "#8b0000" },
            { name: "Emerald", hex: "#50c878" },
            { name: "Royal Gold", hex: "#b8860b" },
            { name: "Burgundy", hex: "#800020" },
            { name: "Peach", hex: "#ffdab9" },
            { name: "Coral", hex: "#ff7f50" },
            { name: "Mustard", hex: "#ffdb58" },
            { name: "Terracotta", hex: "#e2725b" },
            { name: "Blue", hex: "#87ceeb" },
            { name: "Silver", hex: "#c0c0c0" },
            { name: "Lavender", hex: "#e6e6fa" },
            { name: "Teal", hex: "#008080" },
            { name: "Blush", hex: "#ffc0cb" },
            { name: "Beige", hex: "#f5f5dc" },
            { name: "Ivory", hex: "#fffff0" },
            { name: "Baby Blue", hex: "#89cff0" },
          ];

          this.currentHex = "#ff0000";
          this.drawWheel();
          this.addEventListeners();
        }

        drawWheel() {
          this.ctx.clearRect(0, 0, 350, 350);

          const gradient = this.ctx.createLinearGradient(0, 0, 350, 0);
          for (let i = 0; i < 7; i++) {
            gradient.addColorStop(i / 6, `hsl(${i * 51.4},100%,50%)`);
          }
          this.ctx.fillStyle = gradient;
          this.ctx.fillRect(0, 0, 350, 350);

          this.ctx.fillStyle = "rgba(255,255,255,0.3)";
          this.ctx.beginPath();
          this.ctx.arc(this.centerX, this.centerY, this.radius, 0, Math.PI * 2);
          this.ctx.fill();

          this.drawPointer();
        }

        drawPointer() {
          const hslMatch = this.currentHex.match(/hsl\((\d+)/);
          const hue = hslMatch ? parseInt(hslMatch[1]) : 0;
          const angle = (hue / 360) * Math.PI * 2;

          this.ctx.strokeStyle = this.currentHex;
          this.ctx.lineWidth = 8;
          this.ctx.lineCap = "round";
          this.ctx.shadowBlur = 20;
          this.ctx.shadowColor = this.currentHex;

          this.ctx.beginPath();
          this.ctx.moveTo(this.centerX, this.centerY);
          this.ctx.lineTo(
            this.centerX + Math.cos(angle) * this.radius,
            this.centerY + Math.sin(angle) * this.radius,
          );
          this.ctx.stroke();
          this.ctx.shadowBlur = 0;
        }

        addEventListeners() {
          this.canvas.addEventListener("mousedown", (e) => this.startDrag(e));
          this.canvas.addEventListener("mousemove", (e) => this.drag(e));
          this.canvas.addEventListener("mouseup", () => this.stopDrag());
          this.canvas.addEventListener("mouseleave", () => this.stopDrag());

          this.canvas.addEventListener("touchstart", (e) => {
            e.preventDefault();
            this.startDrag(e.touches[0]);
          });
          this.canvas.addEventListener("touchmove", (e) => {
            e.preventDefault();
            this.drag(e.touches[0]);
          });
          this.canvas.addEventListener("touchend", () => this.stopDrag());

          this.saveBtn.addEventListener("click", () => this.saveBestMatch());
        }

        startDrag(e) {
          this.isDragging = true;
          this.updateColor(e);
        }

        drag(e) {
          if (this.isDragging) {
            this.updateColor(e);
          }
        }

        stopDrag() {
          this.isDragging = false;
        }

        updateColor(e) {
          const rect = this.canvas.getBoundingClientRect();
          let x = e.clientX - rect.left - this.centerX;
          let y = e.clientY - rect.top - this.centerY;

          let angle = Math.atan2(y, x);
          if (angle < 0) angle += 2 * Math.PI;
          const hue = Math.round((angle * 180) / Math.PI);

          this.currentHex = `hsl(${hue},100%,50%)`;
          this.drawWheel();
          this.findMatches(this.currentHex);
        }

        findMatches(pickedHex) {
          const matches = this.allColors
            .map((color) => {
              const distance = this.colorDistance(pickedHex, color.hex);
              return {
                ...color,
                distance,
                score: Math.max(0, 1 - distance),
              };
            })
            .sort((a, b) => a.distance - b.distance)
            .slice(0, 5);

          this.matchesDiv.innerHTML = matches
            .map(
              (match, index) =>
                `<div class="match-item" data-hex="${match.hex}" style="background: ${match.hex}">
              ${index + 1}. ${match.name} 
              <strong>${Math.round(match.score * 100)}%</strong>
            </div>`,
            )
            .join("");

          [...this.matchesDiv.children].forEach((el) => {
            el.onclick = () => this.selectMatch(el.dataset.hex);
          });

          this.bestMatch = matches[0].hex;
          this.saveBtn.style.display = "inline-block";
        }

        colorDistance(c1, c2) {
          const rgb1 = this.hexToRgb(c1);
          const rgb2 = this.hexToRgb(c2);

          const dr = rgb1.r - rgb2.r;
          const dg = rgb1.g - rgb2.g;
          const db = rgb1.b - rgb2.b;
          return Math.sqrt(dr * dr + dg * dg + db * db);
        }

        hexToRgb(hex) {
          const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
          return result
            ? {
                r: parseInt(result[1], 16) / 255,
                g: parseInt(result[2], 16) / 255,
                b: parseInt(result[3], 16) / 255,
              }
            : { r: 0, g: 0, b: 0 };
        }

        selectMatch(hex) {
          this.currentHex = hex;
          this.drawWheel();
          this.findMatches(hex);
        }

        saveBestMatch() {
          const saved = JSON.parse(localStorage.getItem("savedColors") || "[]");
          saved.push({
            color: this.bestMatch,
            name:
              this.allColors.find((c) => c.hex === this.bestMatch)?.name ||
              "Best Match",
            source: "wheel",
            date: new Date().toISOString(),
          });
          localStorage.setItem("savedColors", JSON.stringify(saved));
          document.getElementById("saved-count").textContent =
            `(${saved.length})`;

          const toast = document.createElement("div");
          toast.className = "save-notification show";
          toast.innerHTML = `üíé Saved <strong>${this.bestMatch}</strong>!`;
          document.body.appendChild(toast);
          setTimeout(() => toast.remove(), 2500);
        }
      }

      // Initialize EVERYTHING
      document.addEventListener("DOMContentLoaded", () => {
        const saved = JSON.parse(localStorage.getItem("savedColors") || "[]");
        document.getElementById("saved-count").textContent =
          `(${saved.length})`;
        new SkinToneDetector();
        new ColorWheel();
      });
    </script>
  </body>
</html>
